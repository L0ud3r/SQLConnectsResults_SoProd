@model List<SoProd.Web.Models.TestResultViewModel>

@{
    ViewBag.Title = "Home Page";
}

<style>
    .tablerow:hover {
        cursor: pointer;
        background-color: lightgray;
    }

    .result-box {
        display: flex;
        flex-direction: column;
        border: 3px solid lightblue;
        padding: 5px;
        text-align:center
    }

    .result-box-line {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
</style>

<div class="portlet box blue">
    <div class="portlet-title">
        <div class="caption">
            <i class="fa fa-cogs"></i>Results Comparation
        </div>
        <div class="tools">
            <a href="javascript:;" class="reload">
            </a>
        </div>
    </div>
    <div class="portlet-body" style="display: flex;justify-content:space-around">
        <div>
            <div class="mb-3" style="display: flex; gap: 5px">
                <select id="select2-version-1" class="select2-version-1" style="width: 300px">
                    <option value="">Choose a version</option>
                </select>
                <input id="date-1" type="date" class="form-control" required />
            </div>
            <div id="result1" class="result-box">
                No data
            </div>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: space-between; width: 15%">
            <button type="button" id="btn-compare" class="btn btn-info compare">Compare</button>
            <div id="comparison-result" >jklsdgoijwdsgoisdsdlkçhfgisdfbgousbgo</div>
            <div></div>
        </div>
        <div>
            <div class="mb-3" style="display: flex; gap: 5px">
                <select id="select2-version-2" class="select2-version-2" style="width: 300px">
                    <option value="">Choose a version</option>
                </select>
                <input id="date-2" type="date" class="form-control" required />
            </div>
            <div id="result2" class="result-box">
                No data
            </div>
        </div>
    </div>
</div>




<div class="portlet box red mt-1">
    <div class="portlet-title">
        <div class="caption">
            <i class="fa fa-cogs"></i>Database Results
        </div>
        <div class="tools">
            <a href="javascript:;" class="reload">
            </a>
        </div>
    </div>
    <div class="portlet-body" style="display: block;">
        <div class="mb-3">
            <select id="select2-request" class="select2-request" style="width: 35%">
                <option value="">All Versions</option>
            </select>
        </div>
        <div class="table-responsive">
            <table id="results" class="table">
                <thead>
                    <tr>
                        <th data-field="Id">ID</th>
                        <th data-filed="Identifier">Identifier</th>
                        <th data-filed="StartDate">Start Date</th>
                        <th data-filed="TimeEllapsed">Time Ellapsed (ms)</th>
                        <th data-filed="Version">Version</th>
                        <th data-filed="RequestsNumber">Total Requests</th>
                        <th data-filed="AvgRequestTime">Average Request Time (ms)</th>
                        <th data-filed="RequestPercentage">Ok Percentage</th>
                        <th data-filed="MaxRequestTime">Max Request (ms)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var result in Model)
                    {
                        <tr class="tablerow" data-item-id="@result.Id">
                            <td id="tablerow">@result.Id</td>
                            <td id="tablerow">@result.Identifier</td>
                            <td id="tablerow">@result.StartDate</td>
                            <td id="tablerow">@result.TimeEllapsed</td>
                            <td id="tablerow">@result.Version</td>
                            <td id="tablerow">@result.RequestsNumber</td>
                            <td id="tablerow">@result.AvgRequestTime</td>
                            <td id="tablerow">@result.RequestPercentage %</td>
                            <td id="tablerow">@result.MaxRequestTime</td>
                        </tr>
                        <tr id="executions-@result.Id" style="display: none;">
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        var select = $('#select2-request');
        var select1 = $('#select2-version-1');
        var select2 = $('#select2-version-2');

        select.select2();
        select1.select2();
        select2.select2();

        $.ajax({
            url: '/Home/GetVersions',
            type: 'GET',
            success: function (response) {
                $.each(response.themes, function (index, item) {
                    select.append('<option>' + item + '</option>');
                });
                $.each(response.themes, function (index, item) {
                    select1.append('<option>' + item + '</option>');
                });
                $.each(response.themes, function (index, item) {
                    select2.append('<option>' + item + '</option>');
                });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert("Error on loading data...")
            }
        });

        $(document).ready(function () {
            TableInit('#results');

        });

        $(".tablerow").click(function () {
            // Get the <tr> element
            var itemId = $(this).data("item-id");

            var trElement = document.getElementById(`executions-${itemId}`); // Replace "123" with the actual ID

            // Check if the display property is set to "none"
            if (trElement.style.display === "none") {
                $.ajax({
                    url: "/Home/GetResultExecutions/" + itemId,
                    type: "GET",
                    success: function (data) {
                        var executionsTable = $('<table>').addClass('table').css('width', '100%').attr('id', `result-executions-${itemId}`);
                        var executionsHeader = $('<thead>').appendTo(executionsTable);
                        var executionsBody = $('<tbody>').appendTo(executionsTable);

                        // Add header row
                        var headerRow = $('<tr>').appendTo(executionsHeader);
                        $('<th>').text('ID').appendTo(headerRow);
                        $('<th>').text('URL').appendTo(headerRow);
                        $('<th>').text('Status Code').appendTo(headerRow);
                        $('<th>').text('Time Ellapsed').appendTo(headerRow);
                        $('<th>').text('Start Date').appendTo(headerRow);

                        // Add data rows
                        data.results.forEach(function (execution) {
                            var dataRow = $('<tr>').appendTo(executionsBody);
                            $('<td>').text(execution.Id).appendTo(dataRow);
                            $('<td>').text(execution.URL).appendTo(dataRow);
                            $('<td>').text(execution.StatusCode).appendTo(dataRow);
                            $('<td>').text(execution.TimeEllapsed.toFixed(4)).appendTo(dataRow);

                            var startDateStr = execution.StartDate.toString(); // Convert StartDate to a string

                            if (startDateStr.length > 0) { // Check if startDateStr is not empty
                                var startDate = new Date(parseInt(startDateStr.substr(6))); // Parse the date
                                var formattedStartDate = startDate.toLocaleString(); // Format the date
                                $('<td>').text(formattedStartDate).appendTo(dataRow);
                            }
                        });

                        $("#executions-" + itemId).html($('<td>').attr('colspan', 8).append(executionsTable)).toggle();

                        TableInit(`#result-executions-${itemId}`);
                    },
                    error: function () {
                        alert("Error retrieving test results.");
                    }
                });
            }
            else {
                $("#executions-" + itemId).hide();
            }
        });

        $('#select2-request').on('change', function () {
            // Get the selected value
            var selectedValue = $(this).val();

            // Make an Ajax request to fetch the search results
            $.ajax({
                url: '/Home/SearchResults?version=' + selectedValue,
                type: 'GET',
                data: { searchTerm: selectedValue },
                success: function (response) {
                    // Update the table with the new search results
                    var tbody = $('#results tbody');
                    tbody.empty(); // Clear the current rows in the table body

                    $.each(response.results, function (index, item) {
                        var tr = $('<tr>').addClass('tablerow').attr('data-item-id', item.Id);
                        tr.append($('<td>').text(item.Id));
                        tr.append($('<td>').text(item.Identifier));

                        var startDateStr = item.StartDate.toString();

                        if (startDateStr.length > 0) {
                            var startDate = new Date(parseInt(startDateStr.substr(6)));
                            var formattedStartDate = startDate.toLocaleString().replace(',', '');
                            tr.append($('<td>').text(formattedStartDate));
                        }

                        tr.append($('<td>').text(Math.round(item.TimeEllapsed, 4)));
                        tr.append($('<td>').text(item.Version));
                        tr.append($('<td>').text(item.RequestsNumber));
                        tr.append($('<td>').text(item.AvgRequestTime));
                        tr.append($('<td>').text(item.RequestPercentage));
                        tr.append($('<td>').text(item.MaxRequestTime));
                        tbody.append(tr);
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert('Error on loading data...');
                }
            });
        });

        $("#btn-compare").click(function () {

            let comparison = {
                Version1: $('#select2-version-1 option:selected').val(),
                Date1: $("#date-1").val(),
                Version2: $('#select2-version-2 option:selected').val(),
                Date2: $("#date-2").val()
            };

            $.ajax({
                url: '/Home/Compare',
                type: 'POST',
                data: comparison,
                success: function (response) {
                    const comparison1 = response.resultComparison.comparison1;

                    // Select the HTML element to update
                    const result1 = document.querySelector('#result1');

                    // Create the new HTML structure with the updated values
                    const newHtml1 = `
                        <div class="result-box-line">
                            <label>Request Average</label>
                            <label id="c1-avg">${comparison1.AvgRequest.toFixed(2)}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Total Requests</label>
                            <label id="c1-total">${comparison1.TotalRequest}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Users Number</label>
                            <label id="c1-users">${comparison1.UsersNumber}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Requests OK (%)</label>
                            <label id="c1-ok">${comparison1.PercentRequest.toFixed(2)}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Max Request Time (ms)</label>
                            <label id="c1-max">${comparison1.MaxRequest.toFixed(2)}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Tests Number</label>
                            <label id="c1-tests">${comparison1.TestsCount}</label>
                        </div>
                    `;

                    const comparison2 = response.resultComparison.comparison2;

                    // Select the HTML element to update
                    const result2 = document.querySelector('#result2');

                    // Create the new HTML structure with the updated values
                    const newHtml2 = `
                        <div class="result-box-line">
                            <label>Request Average Time (ms)</label>
                            <label id="c2-avg">${comparison2.AvgRequest.toFixed(2)}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Total Requests</label>
                            <label id="c2-total">${comparison2.TotalRequest}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Users Number</label>
                            <label id="c2-users">${comparison2.UsersNumber}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Requests OK (%)</label>
                            <label id="c2-ok">${comparison2.PercentRequest.toFixed(2)}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Max Request Time (ms)</label>
                            <label id="c2-max">${comparison2.MaxRequest.toFixed(2)}</label>
                        </div>
                        <div class="result-box-line">
                            <label>Tests Number</label>
                            <label id="c2-tests">${comparison2.TestsCount}</label>
                        </div>
                    `;

                    result1.innerHTML = newHtml1;
                    result2.innerHTML = newHtml2;

                    let points1 = 0
                    let points2 = 0

                    if (comparison1.AvgRequest < comparison2.AvgRequest) {
                        document.querySelector('#c1-avg').style.color = 'green';
                        points1 = points1 + 1;
                    }
                    else {
                        document.querySelector('#c2-avg').style.color = 'green';
                        points2 = points2 + 1;
                    }

                    if (comparison1.TotalRequest > comparison2.TotalRequest) {
                        document.querySelector('#c1-total').style.color = 'green';
                        points1 = points1 + 1;
                    }
                    else {
                        document.querySelector('#c2-total').style.color = 'green';
                        points2 = points2 + 1;
                    }

                    if (comparison1.UsersNumber > comparison2.UsersNumber) {
                        document.querySelector('#c1-users').style.color = 'green';
                        points1 = points1 + 1;
                    }
                    else {
                        document.querySelector('#c2-users').style.color = 'green';
                        points2 = points2 + 1;
                    }

                    if (comparison1.PercentRequest > comparison2.PercentRequest) {
                        document.querySelector('#c1-ok').style.color = 'green';
                        points1 = points1 + 1;
                    }
                    else {
                        document.querySelector('#c2-ok').style.color = 'green';
                        points2 = points2 + 1;
                    }

                    if (comparison1.MaxRequest < comparison2.MaxRequest) {
                        document.querySelector('#c1-max').style.color = 'green';
                        points1 = points1 + 1;
                    }
                    else {
                        document.querySelector('#c2-max').style.color = 'green';
                        points2 = points2 + 1;
                    }

                    if (comparison1.TestsCount > comparison2.TestsCount) {
                        document.querySelector('#c1-tests').style.color = 'green';
                        points1 = points1 + 1;
                    }
                    else {
                        document.querySelector('#c2-tests').style.color = 'green';
                        points2 = points2 + 1;
                    }


                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR.responseText);
                }
            });
        })

    </script>
}